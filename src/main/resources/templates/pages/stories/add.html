<!DOCTYPE html>
<html lang="ko"  xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header.html :: head"/>
<body>
<div class="row" style="height: 100%">
  <div th:replace="fragments/header.html :: side-bar" />
  <div class="offset-1 col-6">
    <br/><br/>
    <form class="form-group story-form" th:object="${storyAddRequest}" id="storyAddRequest" align="left">
      <h1>스토리 추가</h1><hr/>
      <div>
        <label th:for="group">그룹 선택</label><br/>
        <select th:field="*{group}" style="height: 40px; width: 300px;">
          <option th:each="group : ${groups}" th:text="${group.name}" th:value="${group.name}"></option>
        </select>
      </div>
      <br/>
      <div>
        <label th:for="title">제목</label><br/>
        <input type="text" th:field="*{title}" id="title" style="width: 300px"/>
      </div>
      <br/>
      <div>
        <label th:for="body">내용</label><br/>
        <textarea rows="3" style="width: 500px;" th:field="*{body}" id="body"/>
      </div>
      <br/>
      <div>
        <label th:for="images">사진 첨부(최대 5개)</label><br/>
        <input type="file" th:field="*{images}" id="images" multiple="multiple"/>
      </div>
      <br/>
      <div>
        <input type="radio" name="scope" value="PUBLIC" checked> 공개
        <input type="radio" name="scope" value="PRIVATE" style="margin-left: 10px"> 비공개
      </div>
      <br/><br/>
      <div align="center">
        <button id="addBtn" class="btn story-form-btn" type="button" onclick="add_story()">추가</button>
        <button class="btn story-form-btn" type="button" onclick="location.href='/calendars'" style="margin-left: 20px">취소</button>
      </div>
    </form>
  </div>
</div>
</body>

<script th:inline="javascript">
  let namePass, enterCodePass = false

  function add_story() {
    $.ajax({
      type: 'POST',
      url: '/api/stories',
      data: $('#storyAddRequest').serialize(),
      success: function () {
        alert('스토리가 추가되었습니다.')
        location.href='/calendars'
      }, error: function (res) {
        alert(res.responseJSON.result.message)
      }
    })
  }

  function check_all() {
    if (namePass && enterCodePass) {
      document.getElementById('addBtn').removeAttribute("disabled")
    }
  }

  function check_name() {
    let inputName = $("#name").val()
    namePass = false

    document.getElementById('addBtn').setAttribute("disabled", "true")

    // 공백 체크
    if (inputName.search(/\s/) !== -1) {
      document.getElementById('nameFail').removeAttribute("hidden")
      document.getElementById('nameFail').innerText = "그룹명에는 공백이 포함될 수 없습니다."
      document.getElementById('namePass').setAttribute("hidden", "true")
      return
    }

    // 글자수 체크
    if (inputName.length < 2) {
      document.getElementById('nameFail').removeAttribute("hidden")
      document.getElementById('nameFail').innerText = "그룹명은 2글자 이상만 가능합니다."
      document.getElementById('namePass').setAttribute("hidden", "true")
      return
    } else if (inputName.length > 15) {
      document.getElementById('nameFail').removeAttribute("hidden")
      document.getElementById('nameFail').innerText = "그룹명은 15글자 이하만 가능합니다."
      document.getElementById('namePass').setAttribute("hidden", "true")
      return
    }

    $.ajax({
      type: 'GET',
      url: '/api/groups/check-name',
      data: {
        name: inputName
      },
      success: function (res) {
        if (res.result == true) {
          document.getElementById('namePass').removeAttribute("hidden")
          document.getElementById('nameFail').setAttribute("hidden", "true")
          namePass = true
          check_all()
        } else {
          document.getElementById('nameFail').removeAttribute("hidden")
          document.getElementById('nameFail').innerText = "그룹명이 중복됩니다."
          document.getElementById('namePass').setAttribute("hidden", "true")
        }
      }
    })
  }

  function check_enterCode() {
    let inputEnterCode = $("#enterCode").val()
    enterCodePass = false

    document.getElementById('addBtn').setAttribute("disabled", "true")

    // 한글, 공백 체크
    if (/[ㄱ-ㅎㅏ-ㅣ가-힣]/g.test(inputEnterCode)) {
      document.getElementById('enterCodeFail').removeAttribute("hidden")
      document.getElementById('enterCodeFail').innerText = "입장 코드에는 한글이 포함될 수 없습니다."
      document.getElementById('enterCodePass').setAttribute("hidden", "true")
      return
    } else if (inputEnterCode.search(/\s/) !== -1) {
      document.getElementById('enterCodeFail').removeAttribute("hidden")
      document.getElementById('enterCodeFail').innerText = "입장 코드에는 공백이 포함될 수 없습니다."
      document.getElementById('enterCodePass').setAttribute("hidden", "true")
      return
    }

    // 글자수 체크
    if (inputEnterCode.length < 5) {
      document.getElementById('enterCodeFail').removeAttribute("hidden")
      document.getElementById('enterCodeFail').innerText = "입장 코드는 5글자 이상만 가능합니다."
      document.getElementById('enterCodePass').setAttribute("hidden", "true")
      return
    } else if (inputEnterCode.length > 20) {
      document.getElementById('enterCodeFail').removeAttribute("hidden")
      document.getElementById('enterCodeFail').innerText = "입장 코드는 20글자 이하만 가능합니다."
      document.getElementById('enterCodePass').setAttribute("hidden", "true")
      return
    }

    document.getElementById('enterCodePass').removeAttribute("hidden")
    document.getElementById('enterCodeFail').setAttribute("hidden", "true")
    enterCodePass = true
    check_all()
  }
</script>

</html>