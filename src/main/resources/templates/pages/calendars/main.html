<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/html">
<head th:replace="fragments/header.html :: head"/>
<body>
<div class="row" style="height: 100%">
    <div th:replace="fragments/header.html :: side-bar" />
    <div class="col-9" style="margin-left: 20px">
        <br/>
        <div class="d-flex">
            <h1 id="year-month" style="margin-right: 30px"></h1>
            <div style="display: flex; justify-content: center; align-items: center">
                <button class="btn calendar-btn" type="button" onclick="move_month('prev')">&lsaquo;</button>
                <button class="btn calendar-btn" type="button" onclick="move_month('next')">&rsaquo;</button>
                <button class="btn calendar-btn" style="width: 70px; margin-right: 30px"
                        type="button" onclick="move_month('now')">오늘</button>
                <div>
                    <label th:for="groupName">그룹 : </label>
                    <select id="groupName" style="height: 40px; width: 200px;" onchange="change_group()">
                        <option th:each="group : ${groupList}" th:text="${group.name}" th:value="${group.name}"
                                th:selected="${groupName == group.name}"></option>
                    </select>
                </div>
            </div>
        </div>
        <div class="d-flex justify-content-between" style="height: 50px">
            <div style="display: flex; justify-content: center; align-items: center">
                <label><input type="radio" name="calendar-type" value="calendar" checked><span>&nbsp;달력형</span></label>&nbsp;&nbsp;
                <label><input type="radio" name="calendar-type" value="line"><span>&nbsp;열거형</span></label>
            </div>
            <button class="btn story-btn" type="button" onclick="location.href='/stories/add'">스토리 추가</button>
        </div>
        <table class="table calendar-table">
            <thead style="background-color: #333333">
                <tr>
                    <th style="color: red">일</th>
                    <th>월</th>
                    <th>화</th>
                    <th>수</th>
                    <th>목</th>
                    <th>금</th>
                    <th style="color: red">토</th>
                </tr>
            </thead>
            <tbody id="calendar-body">
            </tbody>
        </table>
    </div>
</div>
<script th:inline="javascript">

    let groupName

    window.onload = function () {
        groupName = [[${groupName}]]
        make_calendar()
    }

    function make_calendar() {

        let nowDate = new Date()

        let year = [[${year}]]
        let month = [[${month}]]
        document.getElementById('year-month').innerText = year + " " + month.toString().padStart(2, '0')
        month --;

        let firstDate = new Date(year, month, 1);
        let lastDate = new Date(year, month + 1, 0);

        let html = "<tr>"
        for (let i = 1 ; i <= firstDate.getDay() % 7 ; i ++) {
            html +="<td></td>"
        }
        for (let i = 1 ; i <= lastDate.getDate() ; i ++) {
            let tempDate = new Date(year, month, i);
            if (tempDate.getDay() == 6 || tempDate.getDay() == 0) {
                if (tempDate.getFullYear() == nowDate.getFullYear() && tempDate.getMonth() == nowDate.getMonth() && tempDate.getDate() == nowDate.getDate()) {
                    html += "<td class='calendar-td calendar-red' style='background-color: lightgoldenrodyellow' id='"+ tempDate.getDate().toString().padStart(2, '0') +"'><strong>" + tempDate.getDate() + "</strong></td>"
                } else {
                    html += "<td class='calendar-td calendar-red' id='"+ tempDate.getDate().toString().padStart(2, '0') +"'><strong>" + tempDate.getDate() + "</strong></td>"
                }

                if (tempDate.getDay() == 6) {
                    html += "</tr><tr>"
                }
            } else {
                if (tempDate.getFullYear() == nowDate.getFullYear() && tempDate.getMonth() == nowDate.getMonth() && tempDate.getDate() == nowDate.getDate()) {
                    html += "<td class='calendar-td' style='background-color: lightgoldenrodyellow' id='"+ tempDate.getDate().toString().padStart(2, '0') +"'><strong>" + tempDate.getDate() + "</strong></td>"
                } else {
                    html += "<td class='calendar-td' id='"+ tempDate.getDate().toString().padStart(2, '0') +"'><strong>" + tempDate.getDate().toString().padStart(2, '0') + "</strong></td>"
                }
            }
        }
        html += "</tr>"
        $('#calendar-body').append(html)

        get_story_list()
    }

    function get_story_list() {
        let storyList;

        $.ajax({
            type: 'GET',
            url: '/api/stories/list',
            data: {
                groupName: groupName,
                year: [[${year}]],
                month: [[${month}]]
            },
            success: function (res) {
                storyList = res.result
            }, error: function (res) {
                alert(res.responseJSON.result.message)
                location.href='/calendars'
            }
        }).done( function () {
            for (var i = 0 ; i < storyList.length ; i ++) {
                let id = storyList[i].id.toString()
                let targetId = storyList[i].date.toString().slice(-2)
                let title = storyList[i].title.toString()
                let scope = storyList[i].scope.toString()

                if (scope == 'PUBLIC') {
                    $('#' + targetId).append(
                        "<br/><button type='button' class='calendar-td-btn' " +
                        "onclick=\"location.href='/stories/" + id + "'\">" + title + "</button>")
                } else {
                    $('#' + targetId).append(
                        "<br/><button type='button' class='calendar-td-btn' " +
                        "onclick=\"location.href='/stories/" + id + "'\"><i class='bi bi-lock-fill'></i>" + title + "</button>")
                }
            }
        })
    }

    function move_month(to) {

        let year, month

        if (to == 'now') {
            let nowDate = new Date()
            year = nowDate.getFullYear()
            month = nowDate.getMonth() + 1
        } else {
            month = [[${month}]]
            year = [[${year}]]

            if (to == 'next') {
                if (month == 12) {
                    month = 1
                    year ++
                } else {
                    month ++
                }
            } else {
                if (month == 1) {
                    month = 12
                    year --
                } else {
                    month --
                }
            }
        }
        location.href = '/calendars?year=' + year + "&month=" + month + "&groupName=" + groupName
    }

    function change_group() {
        groupName = $("#groupName").val()
        location.href = '/calendars?year=' + [[${year}]] + "&month=" + [[${month}]] + "&groupName=" + groupName
    }
</script>
</body>
</html>